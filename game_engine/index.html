<!DOCTYPE html>
<html>
<head>
	<title>HTML5 Game Engine</title>
	<script src="ball.js"></script>
	<script src="animation.js"></script>
	<script src="hero.js"></script>
	<script src="keyboard.js"></script>
	<script src="spritesheet.js"></script>
	<script src="sonic.js"></script>
	<script src="colisor.js"></script>
	<script src="spaceship.js"></script>
	<script src="bullet.js"></script>
	<script src="background.js"></script>
	<script src="ovni.js"></script>
	<script src="explosion.js"></script>
	<style>
		body { text-align: center; background: #ecf0f1; }
		canvas { border: 1px dotted #7f8c8d; margin: 100px 0; }
	</style>
</head>
<body>
	<canvas id="canvas" width="500" height="500"></canvas>
	<script>

		// get canvas and set context
		var canvas = document.getElementById('canvas'),
			ctx    = canvas.getContext('2d');

		// Create variables
		var animation,
			keyboard,
			collision,
			bg1,
			bg2,
			bg3,
			images,
			spaceship,
			ovni,
			generateOvni,
			total  = 0,
			loaded = 0;

		// Load images
		loadImages();
		function loadImages() {
			images = {
				space: 'fundo-espaco.png',
				stars: 'fundo-estrelas.png',
				cloud: 'fundo-nuvens.png',
				spaceship: 'nave-spritesheet.png',
				ovni: 'ovni.png',
				explosion: 'explosao.png'
			}

			for ( var i in images ) {
				total++;

				var img = new Image();
					img.src = images[i];
					img.onload = loading;

				images[i] = img;
			}
		}
		function loading() {
			loaded++;
			if ( loaded == total ) init();
		}

		// Init
		function init() {
			animation = new Animation(ctx);
			keyboard  = new Keyboard(document);
			collision = new Collision();
			bg1       = new Background(ctx, images.space);
			bg2       = new Background(ctx, images.stars);
			bg3       = new Background(ctx, images.cloud);
			spaceship = new Spaceship(ctx, keyboard, images.spaceship, images.explosion);

			animation.addSprite(bg1);
			animation.addSprite(bg2);
			animation.addSprite(bg3);
			animation.addSprite(spaceship);

			animation.addProcess(collision);
			collision.addSprite(spaceship);

			config();
		}

		// Initial config
		function config() {
			bg1.speed = 60;
			bg2.speed = 150;
			bg3.speed = 500;

			spaceship.x = canvas.width/2 - 18;
			spaceship.y = canvas.height - 48;
			spaceship.speed = 200;

			keyboard.tap(KEY_SPACE, function() {
				spaceship.shot();
			});

			animation.start();

			generateEnemy();
		}

		// Generate enemy
		function generateEnemy() {
			generateOvni = {
				last_time: new Date().getTime(),
				process: function() {
					var now = new Date().getTime();
					if ( now - this.last_time > 1000 ) {
						newOvni();
						this.last_time = now;
					}
				}
			}

			animation.addProcess(generateOvni);
		}
		function newOvni() {
			var ovni = new Ovni(ctx, images.ovni, images.explosion);
				ovni.x = Math.floor(Math.random() * ( canvas.width - images.ovni.width + 1 ));
				ovni.y = -images.ovni.height;
				ovni.speed = Math.floor(200 + Math.random() * (800 - 200 + 1));

			animation.addSprite(ovni);
			collision.addSprite(ovni);
		}
	</script>
</body>
</html>
